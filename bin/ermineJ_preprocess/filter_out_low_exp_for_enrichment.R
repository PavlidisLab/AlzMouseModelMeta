#' 2016-03-03
#' updated 2016-03-06
#' @note use wrapper_filter_out_low_for_enrichment.R
#' 
#' For the background ermineJ genes: filter lowly expressed genes, and multiple genes that mapped by a probe (optional)
#' For the input meta or jackknife file: use the the filtered background gene list to rm the lowly expressed genes
#' @note f_erminej_anno
#'  this file is generated by get_all_gene_annotation.R, which input a list of platforms, and generate a summary file
#'  with all gene symbols (ignore probe names from different platforms) and their correponding gene name and GO terms
#'  if the same gene symbol has different GO terms, or some with empty GO entry, only the first one with the GO term
#'  is retained.
#'  @examples
#  
# source("./ermineJ_preprocess//filter_out_low_exp_for_enrichment.R")
# file_dir_ls <- c("/home/bzhuang/AD_mouse_model_project/limma_DE/hippocampus/CEL_prioritized_limma/2016-02-15/GSE48622/",
#                  "/home/bzhuang/AD_mouse_model_project/limma_DE/hippocampus/CEL_prioritized_limma/2016-02-15/GSE36237/",
#                  "/home/bzhuang/AD_mouse_model_project/limma_DE/hippocampus/CEL_prioritized_limma/2016-02-23/GSE63617.1/")
# 
# f_erminej_anno <- "/home/bzhuang/AD_mouse_model_project/data_and_QC/design_and_annotation/platforms/ermineJ_early_gene_annotations.tsv"
# fo_erminej_bg_filter <- "/home/bzhuang/AD_mouse_model_project/ermineJ/background/ermineJ_early_gene_annotations_low_expr_filtered.tsv"
# 
# df_filtered <- mainFilterLowExprGenesBackground(file_dir_ls, f_erminej_anno, fo_erminej_bg_filter,filter_method = "median",
#                                                 rm_multi_gene =T, 
#                                                 affy_threshold = 6, agilent_threshold = 0,
#                                                 df_return = T)


 
## get helper functions
source("./meta_analysis/plot_sig_genes_helper.R")

###############################################################
## functions
###############################################################
#' input a list of folders with R object. For each study, filter the probes that are either expressed in all samples (all_sample =T)
#' or expressed in at least 1 sample (all_sample =F)
#' @param file_dir_ls: list of dirs where the R object (contain array_dat, array_design, gene annotation etc) of the selected datasets
#'                  or a list of Rdata files(must be after limma (due to some arrays are batch corrected))
#' @param affy_threshold expr threshold for affy
#' @param agilent_threshold expr threshold for agilent (2 color?)
#' @filter_method =c("max", "min", "median", "mean") max: expressed in all sample, min: expressed in at least 1 sample; 
#' median/mean: median/mean over threshold
#' @param return_array: if return a array_dat

filterLowExprGenes <- function(file_dir_ls, affy_threshold = 6, agilent_threshold = 0, 
                               filter_method =c("max", "min", "median", "mean"), return_array = F){
    df_all <- NULL
    msg_obj <-""
    for (file_dir in file_dir_ls){
        print(file_dir)
        if(grepl('.Rdata$', file_dir)){  ## if the list is already a Rdata
          object_dir <- file_dir
        } else{   # else look for Rdata files
          all_files <- list.files(file_dir, full.names = T, recursive = T)
          (object_dir <- grep("objects", all_files, value = T))
        }

      

        load(object_dir)
        
        ## get the index based on filter_method
        filter_method <- filter_method[1]
        assign("index_exp", eval(parse(text = paste0("apply(as.matrix(array_dat),1,",filter_method, ")"))))
        
        ## remove low exp 
        if(range(index_exp)[1] >0){
            df <- array_dat[which(index_exp > affy_threshold), ]   #(for Affy)
        }else{
            df <- array_dat[which(index_exp > agilent_threshold), ]  #for agilent...
        }
        
        if(return_array){
          return(df)
        }
        
        df <- na.omit(mapBindAllColumns(df, gene_annotation[, 1:2]))
        
        gene_list <- setdiff(unique(df$GeneSymbols), "")
        msg_obj <- paste0(msg_obj, "\n# ", object_dir, " (Genes: ", length(gene_list), ")")
        df_all <- union(df_all, gene_list)
        print(length(df_all))  #get all genes that have expression
    }
    
    msg <- paste0("# Filtered by ", filter_method, " of the expression. \n# Affymetrix threshold: ", affy_threshold,
                  "\n# Agilent threshold: ",agilent_threshold)
    msg_full <- paste0(msg, "\n# Input Expression files: ", msg_obj)
    cat(msg)
    returnlist <- list(df_all, msg, msg_full)

    return(returnlist)
}

###############################################################
## Mainfunction
###############################################################
#' @param rm_meta_NA: (optional) remove NA in Fisher (meta file); adj_combined_max_p in jackknife
#' 
mainFilterLowExprGenesBackground <- function(file_dir_ls,
                                   f_erminej_anno, fo_erminej_bg_filter,filter_method = "median",
                                   rm_multi_gene = T, 
                                   affy_threshold = 6, agilent_threshold = 0,
                                   df_return = F){
    ##-----------
    ## filter the background genes
    ##-----------
    
    ## get the expressed genes
    x<- filterLowExprGenes(file_dir_ls, affy_threshold, agilent_threshold, filter_method)
    df_all <- x[[1]]
    filter_msg <- x[[2]]
    filter_msg_full <- x[[3]]
    
    ## check the all genes from the background (without genes filtered)
    df <- read.delim(f_erminej_anno, comment.char= "#")
    msg_count <- paste0("\n# original gene count: ", nrow(df))
    a_gene_list <- as.character(df$geneSymbol)
    rownames(df) <- df$geneSymbol
    
    ## get the overlap and a final list of genes that are expressed in the form the a_gene_list
    df3 <- intersect(df_all, a_gene_list)
    df_filtered <- df[df3, ]
    msg <- paste0("# ", Sys.Date(), "\n", filter_msg_full, msg_count, "\n# lowly expressed genes count: ", nrow(df)-nrow(df_filtered))
    
    
    if(rm_multi_gene){
        ## rm probes that mapped to multiple genes (these probes are not specific to 1 gene, thus not useful)
        index <- grep('\\|', df_filtered$geneSymbol)
        (msg <- paste0(msg, '\n# Multiple genes (mapped by a probe) removed: ', length(index)))
        df_filtered <- df_filtered[-index, ] %>%droplevels()
    }
    
    msg <- paste0(msg, "\n# Final filtered count: ", nrow(df_filtered))
    sink(fo_erminej_bg_filter, type="output")
    writeLines(msg)
    sink()
    ## write the filtere erminej background
    write.table(df_filtered, file= fo_erminej_bg_filter, sep = "\t", quote =F, row.names = F, append = T)
    print(paste0("Output new ermineJ background file: ", fo_erminej_bg_filter))
    
    if(df_return){return(df_filtered)}
}


###############################################################
## run to filter meta and jackkife
###############################################################

FilterLowExprGenesMeta <- function(fo_erminej_bg_filter,
                                   f_meta = "", fo_meta = "",
                                   rm_meta_NA = T){
    
    df_filtered <- read.delim(fo_erminej_bg_filter, comment.char="#")
    ##-----------
    ## process the meta or jackknife files, filter low genes, and filter Fisher NA genes 
    ##-----------
    
    if(f_meta[1] == ""){
        stop(paste0("No meta/jackknife file to process"))
    }else if(length(f_meta) != length(fo_meta)){## if a meta file input and output is required (can be a list)
        stop(paste0("input f_meta has ", length(f_meta), "files. output fo_meta has ", length(fo_meta), "not filtered meta/jackknife file output"))
    }
    
    print("PROCESS META or JACKKINFE files")
    for(i in 1:(length(f_meta))){
        print(paste0("process ", f_meta[i]))
        df_meta <- read.delim(f_meta[i], comment.char="#")
        row.names(df_meta) <- df_meta$geneSymbol
        old_count <- nrow(df_meta)
        (msg <- paste0("# ", Sys.Date(), "\n# Input file is ", f_meta[i], 
                       "\n# Filtered by background genes: ", fo_erminej_bg_filter, "\n# Original gene count: ", old_count))
        
        ## get overlap genes 
        index <- intersect(row.names(df_meta), df_filtered$geneSymbol)
        df_meta <- df_meta[index, ]
        msg<- paste0(msg, "\n# lowly expressed genes removed: ", old_count - nrow(df_meta))
        
        ## (optional) remove NA in Fisher (meta file); adj_combined_max_p in jackknife
        if(rm_meta_NA){
            old_count <- nrow(df_meta)
            if("Fisher" %in% colnames(df_meta)){
                index <- which(is.na(df_meta$Fisher))
                if(length(index)>0){df_meta <- df_meta[-index, ]%>%droplevels()}
                msg <- paste0(msg, "\n# Fisher value with NA removed: ", length(index))                   
            }else if ("adj_combined_max_p" %in% colnames(df_meta)){
                index <- which(is.na(df_meta$adj_combined_max_p))
                if(length(index)>0){df_meta <- df_meta[-index, ]%>%droplevels()}
                msg<- paste0(msg, "\n# Meta or jackkinfe genes with NA value removed : ", old_count - nrow(df_meta))  
            }
        }else{
            msg<- paste0(msg, "\n# NA value genes not removed.")}
        print(msg)
        ## write file
        fo <- fo_meta[i]
        msg <- paste0(msg, "\n# Final gene count: ",nrow(df_meta))
        sink(fo, type="output")
        writeLines(msg)
        sink()
        ## write the filtered file
        noWarnings(write.table(df_meta, file= fo, sep = "\t", quote =F, row.names = F, append = T))
    }}







